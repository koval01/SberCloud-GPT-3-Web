const re_pub = "6LePxpUbAAAAAEY8PaOLVXNEIG1ZN_pLA5azZo0O";

function fix_response(text) {
  let re = '';
  let errors =  text.match(re);
  
}
function display_hint() {
  let hint = $("#prompt_select_story");
  hint.css({"display": "inline-block", "margin-top": "0"});
}
function select_story(el) {
  let jthis = jQuery(el);
  let text = jthis.find("blockquote").text();
  $("textarea").val(text);
  window.scrollTo({top: 0, behavior: 'smooth'});
}
function format_result(start_, list_) {
  let result_list = [];
  list_ = list_.replies
  
  for (let i = 0; i < list_.length; i++) {
    result_list.push("<figure class=\"border-bottom\" onclick=\"select_story(this)\"><blockquote class=\"blockquote\"><b>"+start_+"</b><i>"+list_[i]+"</i></blockquote><figcaption class=\"blockquote-footer\">story.q-writer.com</figcaption></figure>");
  }
  return result_list;
}
function generate_continue() {
    grecaptcha.ready(function () {
      grecaptcha.execute(re_pub, {action: "submit"}).then(function (i) {
        const url = "https://pelevin.gpt.dobro.ai/generate/";
        const len_c = 60;
        const smp_c = 5;
        const button = $("#generate_continue_button"),
            loader = button.find("span");
        var txt_c = $("textarea").val();

        if (!txt_c.length) {
          txt_c = "Вчера я";
          $("textarea").val(txt_c);
        }
        
        $.ajax({
          url: url,
          type: "POST",
          contentType: "application/json",
          headers: {
            "re_token": i,
          },
          data: JSON.stringify({
            prompt: txt_c,
            length: len_c,
            num_samples: smp_c,
          }),
          beforeSend: function () {
            loader.css("display", "inline-block");
            button.prop('disabled', true);
          },
          success: function (o) {
            display_hint();
            let block = $("#result_continue_block");
            loader.css("display", "none");
            button.prop('disabled', false);
            block.empty(), block.append(format_result(txt_c, o));
            document.getElementById('result_continue_block').scrollIntoView({
              behavior: 'smooth'
            });
          },
          error: function () {
            loader.css("display", "none");
            button.prop('disabled', false);
            alert("Извините, но произошла ошибка...");
          },
        });
      });
    });
}
